
# Установка Apache Airflow

Создайте директории в рабочей папке

```
mkdir -p ./dags ./logs ./plugins ./config
```

Задайте параметр ***AIRFLOW_UID*** в файле ***.env***. Если команда возвращает значение 0, задайте параметру значение 50000. 

```
echo -e "AIRFLOW_UID=$(id -u)"
```

Выполните инициализацию образов Apache Airflow.

```
docker compose up airflow-init
```

По рекомендации разработчиков, после инициализации нужно удалить мусор

```
docker compose down --volumes --remove-orphans
```

# Запуск и остановка Apache Airflow

Запустите контейнеры из созданных ранее образов (перед запуском рекомендуется убедиться, что контейнеры уже не запущены, см. "Дополнительные команды")

```
docker compose up
```

Для остановки всех запущенных контейнеров выполните команду ниже из рабочей папки

```
docker compose down
```

# Пользовательский интерфейс

Для доступа в пользовательский интерфейс используйте интернет браузер. Имя пользователя ***airflow***, пароль ***airflow***. Настройка номера порта осуществляется в файле ***docker-compose.yaml***, параметр ***ports*** сервиса ***airflow-webserver***.

```
http://127.0.0.1:8080/
```
# Настройка config/variables.json

В настройках все пути указываются относительно контейнера.
Для корректного функционирования Dag необходимо настроить параметры подключения к датацентрам в разделе ***vcenters***.

| имя переменной | описание |
| -------------- | -------- |
| vmhost | сетевой адрес VMCenter |
| vmuser | указать имя переменной в которой хранится имя пользователя в Airflow (Admin / Variables в пользовательском интерфейсе) |
| vmpassword | указать имя переменной в которой хранится пароль в Airflow (Admin / Variables в пользовательском интерфейсе) |
| output | папка для записи преобразованных файлов на хост машину |

Параметры подключения к серверу Git настраиваются в разделе ***git***.

| имя переменной | описание |
| -------------- | -------- |
| push_script | путь к скрипту, который выполняет отправку сформированных файл в удаленный репозиторий |
| output_dir | папка содержащая сформированные файлы для всех датацентров |

Необходимо предоставить право на запись для папки ***output*** и право на выполнение скриптов в папке ***scripts/***

```
mkdir output
chmod +w output
chmod +x scripts/*.sh
```



